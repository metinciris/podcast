<script>
  const SHEET_ID = '148p3M41R52gVVjtLSF2Qh8rJvBPEWJ7SV4lgSBQYwLc';
  const GID = '1109640564';

  let articles = [];
  let currentIndex = -1;
  let synth = window.speechSynthesis;
  let utterance = null;
  let isPaused = false;

  const articlesEl = document.getElementById('articles');
  const contentPanelEl = document.getElementById('contentPanel');
  const statusEl = document.getElementById('status');
  const prevBtn = document.getElementById('prevBtn');
  const playBtn = document.getElementById('playBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const stopBtn = document.getElementById('stopBtn');
  const nextBtn = document.getElementById('nextBtn');
  const currentTrackEl = document.getElementById('currentTrack');

  // Ses seçimi (varsayılan TR, gerektiğinde EN)
  let voices = [];
  let selectedVoice = null;

  function loadVoices() {
    voices = synth.getVoices();
    selectedVoice = voices.find(v =>
      v.lang === 'tr-TR' ||
      (v.lang && v.lang.toLowerCase().startsWith('tr')) ||
      v.name.toLowerCase().includes('turkish') ||
      v.name.toLowerCase().includes('türk')
    ) || voices[0] || null;
  }
  if (speechSynthesis.onvoiceschanged !== undefined) {
    speechSynthesis.onvoiceschanged = loadVoices;
  }
  loadVoices();

  // İstenen dil koduna göre uygun voice bul
  function pickVoiceByLang(langCode) {
    const all = speechSynthesis.getVoices();
    // Tam eşleşme dene (en-US / tr-TR)
    let v = all.find(v => v.lang === langCode);
    if (!v) {
      // Bölgesiz eşleşme (en / tr)
      const base = langCode.split('-')[0];
      v = all.find(v => v.lang && v.lang.toLowerCase().startsWith(base));
    }
    return v || selectedVoice || all[0] || null;
  }

  // Google Sheets'ten veri çekme
  async function fetchArticles() {
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${GID}&range=A1:E132`;
    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error('Veri alınamadı');
      const text = await res.text();
      const jsonText = text.substring(text.indexOf('(') + 1, text.lastIndexOf(')'));
      const data = JSON.parse(jsonText);
      if (!data.table || !data.table.rows) throw new Error('Tablo verisi alınamadı');

      articles = data.table.rows.map(row => {
        const title = row.c[0]?.v ? String(row.c[0].v).trim() : ''; // A sütunu (EN)
        const detail = row.c[4]?.v ? String(row.c[4].v).trim() : ''; // E sütunu (TR)
        return { title, detail };
      }).filter(a => a.title.length > 0 || a.detail.length > 0);

      renderArticleList();
      enableControls();
      statusEl.textContent = `${articles.length} makale yüklendi.`;
    } catch (e) {
      console.error(e);
      statusEl.textContent = 'Makale verileri yüklenemedi.';
      contentPanelEl.innerHTML = '<p style="color: #e74c3c;">Makale verileri yüklenemedi. Lütfen internet bağlantınızı kontrol edin.</p>';
    }
  }

  function renderArticleList() {
    articlesEl.innerHTML = '';
    articles.forEach((article, idx) => {
      const li = document.createElement('li');
      li.innerHTML = `<div class="article-title">${article.title || '(Başlık yok)'}</div>`;
      li.addEventListener('click', () => {
        playArticle(idx);
      });
      articlesEl.appendChild(li);
    });
  }

  function enableControls() {
    playBtn.disabled = false;
    prevBtn.disabled = true;
    pauseBtn.disabled = true;
    stopBtn.disabled = true;
    nextBtn.disabled = articles.length <= 1;
  }

  function updateSelection() {
    Array.from(articlesEl.children).forEach((li, idx) => {
      li.classList.toggle('active', idx === currentIndex);
    });
    if (currentIndex >= 0 && currentIndex < articles.length) {
      // E sütununu panelde göster
      contentPanelEl.innerHTML = articles[currentIndex].detail || '<p style="color: #7f8c8d; font-style: italic;">Bu makale için detaylı içerik bulunmuyor.</p>';
      const shown = articles[currentIndex].title || '(Başlık yok)';
      currentTrackEl.textContent = `${currentIndex + 1}/${articles.length}: ${shown.substring(0, 50)}${shown.length > 50 ? '...' : ''}`;
    } else {
      contentPanelEl.textContent = 'Bir makale seçin veya oynat düğmesine basın. Burada makalenin detaylı içeriği görünecektir.';
      currentTrackEl.textContent = 'Seçili makale yok';
    }
    prevBtn.disabled = currentIndex <= 0;
    nextBtn.disabled = currentIndex >= articles.length - 1;
  }

  // Çok parçalı okuma: sırayla EN(A) sonra TR(E)
  function speakSequence(sequence, onAllEnd) {
    if (!sequence || sequence.length === 0) return;
    synth.cancel(); // varsa önceki oku iptal

    let i = 0;
    function next() {
      if (i >= sequence.length) {
        onAllEnd && onAllEnd();
        return;
      }
      const seg = sequence[i++];
      const u = new SpeechSynthesisUtterance(seg.text);
      u.lang = seg.lang;
      const v = pickVoiceByLang(seg.lang);
      if (v) u.voice = v;
      u.rate = seg.rate ?? 0.95;  // EN için biraz daha akıcı
      if (seg.lang.startsWith('tr')) u.rate = 0.9; // TR için rahat hız
      u.pitch = 1.0;

      u.onend = () => next();
      u.onerror = () => next();

      // Durum/tuşlar
      statusEl.textContent = `Okunuyor (${seg.lang})...`;
      pauseBtn.disabled = false;
      stopBtn.disabled = false;
      playBtn.disabled = true;

      speechSynthesis.speak(u);
    }
    next();
  }

  // Orijinal tek-parça speak kalsın (gerekirse)
  function speak(text) {
    if (!text) return;
    if (utterance) {
      synth.cancel();
    }
    utterance = new SpeechSynthesisUtterance(text);
    // Normal düzen Türkçe
    const v = pickVoiceByLang('tr-TR');
    if (v) utterance.voice = v;
    utterance.lang = 'tr-TR';
    utterance.rate = 0.9;
    utterance.pitch = 1.0;
    utterance.onend = () => {
      statusEl.textContent = 'Okuma tamamlandı.';
      pauseBtn.disabled = true;
      stopBtn.disabled = true;
      playBtn.disabled = false;
      isPaused = false;
      pauseBtn.textContent = '⏸️ Duraklat';
      if (currentIndex < articles.length - 1) {
        currentIndex++;
        playArticle(currentIndex);
      }
    };
    utterance.onerror = () => {
      statusEl.textContent = 'Sesli okuma sırasında hata meydana geldi.';
    };
    synth.speak(utterance);
    statusEl.textContent = 'Okuma devam ediyor...';
    pauseBtn.disabled = false;
    stopBtn.disabled = false;
    playBtn.disabled = true;
  }

  // Makale oynat: A (EN) + E (TR) – tabloya kod eklemeden
  function playArticle(idx) {
    if (idx < 0 || idx >= articles.length) return;
    currentIndex = idx;
    updateSelection();

    const titleEN = articles[idx].title?.trim();  // A sütunu – İngilizce okut
    const detailTR = articles[idx].detail?.trim(); // E sütunu – Türkçe okut

    const seq = [];
    if (titleEN) seq.push({ lang: 'en-US', text: titleEN });
    if (detailTR) seq.push({ lang: 'tr-TR', text: detailTR });

    if (seq.length === 0) return;

    speakSequence(seq, () => {
      statusEl.textContent = 'Okuma tamamlandı.';
      pauseBtn.disabled = true;
      stopBtn.disabled = true;
      playBtn.disabled = false;
      isPaused = false;
      pauseBtn.textContent = '⏸️ Duraklat';

      // Otomatik sonraki
      if (currentIndex < articles.length - 1) {
        currentIndex++;
        playArticle(currentIndex);
      }
    });
  }

  function pauseReading() {
    if (synth.speaking && !isPaused) {
      synth.pause();
      isPaused = true;
      statusEl.textContent = 'Okuma duraklatıldı.';
      pauseBtn.textContent = '▶️ Devam Et';
    } else if (synth.paused && isPaused) {
      synth.resume();
      isPaused = false;
      statusEl.textContent = 'Okuma devam ediyor...';
      pauseBtn.textContent = '⏸️ Duraklat';
    }
  }

  function stopReading() {
    if (synth.speaking || synth.paused) {
      synth.cancel();
      isPaused = false;
      statusEl.textContent = 'Okuma durduruldu.';
      pauseBtn.disabled = true;
      stopBtn.disabled = true;
      playBtn.disabled = false;
      pauseBtn.textContent = '⏸️ Duraklat';
    }
  }

  function playPrev() {
    if (currentIndex > 0) {
      playArticle(currentIndex - 1);
    }
  }

  function playNext() {
    if (currentIndex < articles.length - 1) {
      playArticle(currentIndex + 1);
    }
  }

  playBtn.addEventListener('click', () => {
    if (currentIndex === -1 && articles.length > 0) {
      playArticle(0);
    } else if (!synth.speaking) {
      playArticle(currentIndex);
    }
  });
  pauseBtn.addEventListener('click', pauseReading);
  stopBtn.addEventListener('click', stopReading);
  prevBtn.addEventListener('click', playPrev);
  nextBtn.addEventListener('click', playNext);

  fetchArticles();
</script>
