<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <title>Günlük Değişen Podcast Makaleler - Prof. Dr. Metin Çiriş</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      margin: 0;
      padding: 0;
      color: #333;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 20px;
      font-size: 2.2em;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }

    .content-panel {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      margin-bottom: 25px;
      border: 1px solid #e1e5e9;
      min-height: 200px;
      font-size: 18px;
      line-height: 1.7;
    }

    .player-container {
      position: sticky;
      top: 0;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      margin-bottom: 25px;
      z-index: 100;
      border: 1px solid #e1e5e9;
    }

    .player-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f1f3f4;
    }

    .player-title {
      font-size: 1.4em;
      font-weight: bold;
      color: #2c3e50;
    }

    .current-track {
      font-size: 0.9em;
      color: #7f8c8d;
      font-style: italic;
    }

    #playerControls {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }

    button {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 90px;
      font-weight: 600;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      background: linear-gradient(135deg, #2980b9 0%, #2471a3 100%);
    }

    button:active:not(:disabled) {
      transform: translateY(0);
    }

    button:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    #status {
      text-align: center;
      font-style: italic;
      color: #7f8c8d;
      min-height: 20px;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 6px;
      font-size: 0.9em;
    }

    .articles-section {
      margin-top: 20px;
    }

    .articles-title {
      font-size: 1.3em;
      color: #2c3e50;
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 2px solid #3498db;
    }

    #articles {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 12px;
    }

    #articles li {
      background-color: white;
      border-radius: 10px;
      padding: 15px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      border-left: 4px solid transparent;
      height: 100%;
    }

    #articles li:hover {
      background-color: #f8f9fa;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      border-left: 4px solid #3498db;
    }

    #articles li.active {
      background-color: #e3f2fd;
      font-weight: bold;
      border-left: 4px solid #e74c3c;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .article-title {
      font-size: 14px;
      line-height: 1.4;
      margin: 0;
    }

    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      h1 {
        font-size: 1.8em;
      }
      
      .content-panel {
        padding: 20px;
        font-size: 16px;
      }
      
      .player-container {
        padding: 15px;
      }
      
      button {
        padding: 10px 15px;
        font-size: 13px;
        min-width: 80px;
      }
      
      #playerControls {
        gap: 5px;
      }
      
      #articles {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .player-header {
        flex-direction: column;
        gap: 8px;
        text-align: center;
      }
      
      button {
        padding: 8px 12px;
        min-width: 70px;
      }
      
      .content-panel {
        padding: 15px;
        font-size: 15px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Prof. Dr. Metin Çiriş - Podcast Makaleler</h1>
    
    <!-- Büyük İçerik Paneli - E Sütunu Burada Gösterilecek -->
    <div class="content-panel" id="contentPanel">
      Bir makale seçin veya oynat düğmesine basın. Burada makalenin detaylı içeriği görünecektir.
    </div>
    
    <!-- Oynatıcı -->
    <div class="player-container">
      <div class="player-header">
        <div class="player-title">Sesli Oynatıcı</div>
        <div class="current-track" id="currentTrack">Seçili makale yok</div>
      </div>
      
      <div id="playerControls">
        <button id="prevBtn" disabled>⏮️ Önceki</button>
        <button id="playBtn" disabled>▶️ Oynat</button>
        <button id="pauseBtn" disabled>⏸️ Duraklat</button>
        <button id="stopBtn" disabled>⏹️ Durdur</button>
        <button id="nextBtn" disabled>⏭️ Sonraki</button>
      </div>
      
      <div id="status">Bir makale seçin ve oynat'a basın</div>
    </div>
    
    <!-- Makale Listesi -->
    <div class="articles-section">
      <div class="articles-title">Makaleler</div>
      <ul id="articles"></ul>
    </div>
  </div>

  <script>
    const SHEET_ID = '148p3M41R52gVVjtLSF2Qh8rJvBPEWJ7SV4lgSBQYwLc';
    const GID = '1109640564';

    let articles = [];
    let currentIndex = -1;
    const synth = window.speechSynthesis;
    let utterance = null;
    let isPaused = false;

    const articlesEl = document.getElementById('articles');
    const contentPanelEl = document.getElementById('contentPanel');
    const statusEl = document.getElementById('status');
    const prevBtn = document.getElementById('prevBtn');
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const stopBtn = document.getElementById('stopBtn');
    const nextBtn = document.getElementById('nextBtn');
    const currentTrackEl = document.getElementById('currentTrack');

    let voices = [];
    let selectedVoice = null;

    function loadVoices() {
      voices = synth.getVoices();
      selectedVoice = voices.find(v =>
        v.lang === 'tr-TR' ||
        (v.lang && v.lang.toLowerCase().startsWith('tr')) ||
        v.name.toLowerCase().includes('turkish') ||
        v.name.toLowerCase().includes('türk')
      );
      if (!selectedVoice && voices.length > 0) {
        selectedVoice = voices[0];
      }
    }
    if (speechSynthesis.onvoiceschanged !== undefined) {
      speechSynthesis.onvoiceschanged = loadVoices;
    }
    loadVoices();

    // ------- Yardımcılar -------
    function pickVoiceByLang(langCode) {
      const all = speechSynthesis.getVoices();
      return all.find(v => v.lang === langCode)
          || all.find(v => v.lang && v.lang.toLowerCase().startsWith(langCode.split('-')[0]))
          || selectedVoice
          || all[0]
          || null;
    }

    function stripLangTags(s) {
      return s.replace(/<lang\s+lang="[^"]*">/g, '').replace(/<\/lang>/g, '');
    }

    // <lang> bloklarını koruyup dış kısımlara otomatik etiket uygula
    const AUTO_TAG = false; // kapatmak istersen false yap
    const KNOWN_EN_TERMS = [
      'Histopathology','The Lancet','Lancet','Nature','Science','Cell','NEJM','BMJ',
      'JAMA','PLOS ONE','Annals of Internal Medicine','Radiology','Gastroenterology'
    ];

    function autoTagEnglish(raw) {
      if (!AUTO_TAG) return raw;

      // Mevcut <lang ...>...</lang> bloklarını koru
      const tags = [];
      let idx = 0;
      let safe = raw.replace(/<lang\s+lang=".*?">.*?<\/lang>/g, (m) => {
        const key = `__LANGTAG_${idx++}__`;
        tags.push(m);
        return key;
      });

      // Bilinen İngilizce terimleri işaretle (çakışmayı azaltmak için uzun adlar önce)
      KNOWN_EN_TERMS.sort((a,b)=>b.length-a.length).forEach(term => {
        const esc = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const rx = new RegExp(`(\\b)(${esc})(\\b)`, 'g');
        safe = safe.replace(rx, `$1<lang lang="en">$2</lang>$3`);
      });

      // İçinde YANYANA EN AZ İKİ BÜYÜK HARF bulunan kelimeleri İngilizce say
      // Örn: DNA, MRI, COVID-19, USA, mRNA -> (mRNA'da "RNA" kısmı tetikler)
      safe = safe.replace(/\b([A-Za-z0-9\-+/&_.]*[A-Z]{2}[A-Za-z0-9\-+/&_.]*)\b/g, (m) => {
        // Eğer zaten bir <lang> içine girmişse (placeholder değil), dokunma
        if (m.startsWith('__LANGTAG_') && m.endsWith('__')) return m;
        // Çift kapsama olmasın: zaten <lang> ile işaretlenmiş kısım restore aşamasında gelecek
        return `<lang lang="en">${m}</lang>`;
      });

      // Placeholder'ları geri yükle
      safe = safe.replace(/__LANGTAG_(\d+)__/g, (_, n) => tags[Number(n)]);

      return safe;
    }

    // ------- Google Sheets'ten veri çekme -------
    async function fetchArticles() {
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${GID}&range=A1:E132`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('Veri alınamadı');
        const text = await res.text();
        const jsonText = text.substring(text.indexOf('(') + 1, text.lastIndexOf(')'));
        const data = JSON.parse(jsonText);
        if (!data.table || !data.table.rows) throw new Error('Tablo verisi alınamadı');

        articles = data.table.rows.map(row => {
          let title = row.c[0] && row.c[0].v ? row.c[0].v.toString().trim() : '';
          let detail = row.c[4] && row.c[4].v ? row.c[4].v.toString().trim() : '';
          return { title, detail };
        }).filter(a => a.title.length > 5);

        renderArticleList();
        enableControls();
        statusEl.textContent = `${articles.length} makale yüklendi.`;
      } catch (e) {
        console.error(e);
        statusEl.textContent = 'Makale verileri yüklenemedi.';
        contentPanelEl.innerHTML = '<p style="color: #e74c3c;">Makale verileri yüklenemedi. Lütfen internet bağlantınızı kontrol edin.</p>';
      }
    }

    function renderArticleList() {
      articlesEl.innerHTML = '';
      articles.forEach((article, idx) => {
        const li = document.createElement('li');
        li.innerHTML = `<div class="article-title">${stripLangTags(article.title)}</div>`;
        li.addEventListener('click', () => {
          playArticle(idx);
        });
        articlesEl.appendChild(li);
      });
    }

    function enableControls() {
      playBtn.disabled = false;
      prevBtn.disabled = true;
      pauseBtn.disabled = true;
      stopBtn.disabled = true;
      nextBtn.disabled = articles.length <= 1;
    }

    function updateSelection() {
      Array.from(articlesEl.children).forEach((li, idx) => {
        li.classList.toggle('active', idx === currentIndex);
      });
      if (currentIndex >= 0 && currentIndex < articles.length) {
        contentPanelEl.innerHTML = articles[currentIndex].detail || '<p style="color: #7f8c8d; font-style: italic;">Bu makale için detaylı içerik bulunmuyor.</p>';
        const clean = stripLangTags(articles[currentIndex].title);
        currentTrackEl.textContent = `${currentIndex + 1}/${articles.length}: ${clean.substring(0, 50)}${clean.length > 50 ? '...' : ''}`;
      } else {
        contentPanelEl.textContent = 'Bir makale seçin veya oynat düğmesine basın. Burada makalenin detaylı içeriği görünecektir.';
        currentTrackEl.textContent = 'Seçili makale yok';
      }
      prevBtn.disabled = currentIndex <= 0;
      nextBtn.disabled = currentIndex >= articles.length - 1;
    }

    // ------- Çok dilli okuma (etiket + otomatik EN) -------
    function speakWithLangTags(rawText) {
      if (!rawText) return;

      // Mevcut okuma varsa iptal
      synth.cancel();

      // Otomatik İngilizce etiketleme uygula (varsa)
      const text = autoTagEnglish(rawText);

      // <lang> parçalarına böl
      const regex = /<lang\s+lang="(.*?)">(.*?)<\/lang>/g;
      let parts = [];
      let lastIndex = 0;
      let match;

      while ((match = regex.exec(text)) !== null) {
        if (match.index > lastIndex) {
          parts.push({ lang: 'tr-TR', text: text.substring(lastIndex, match.index) });
        }
        parts.push({ lang: match[1], text: match[2] });
        lastIndex = regex.lastIndex;
      }
      if (lastIndex < text.length) {
        parts.push({ lang: 'tr-TR', text: text.substring(lastIndex) });
      }

      // Kontrolleri güncelle
      statusEl.textContent = 'Okuma devam ediyor...';
      pauseBtn.disabled = false;
      stopBtn.disabled = false;
      playBtn.disabled = true;
      pauseBtn.textContent = '⏸️ Duraklat';
      isPaused = false;

      // Sırayla okut
      function speakNext(i) {
        if (i >= parts.length) {
          // Tüm parçalar bitti
          statusEl.textContent = 'Okuma tamamlandı.';
          pauseBtn.disabled = true;
          stopBtn.disabled = true;
          playBtn.disabled = false;
          isPaused = false;
          pauseBtn.textContent = '⏸️ Duraklat';

          // Otomatik sonraki makaleye geç
          if (currentIndex < articles.length - 1) {
            currentIndex++;
            playArticle(currentIndex);
          }
          return;
        }
        const seg = parts[i];
        const u = new SpeechSynthesisUtterance(seg.text);
        u.lang = seg.lang || 'tr-TR';
        const v = pickVoiceByLang(u.lang);
        if (v) u.voice = v;
        u.rate = 0.9;
        u.pitch = 1.0;
        u.onend = () => speakNext(i + 1);
        u.onerror = () => speakNext(i + 1); // hatada da devam et
        speechSynthesis.speak(u);
      }

      speakNext(0);
    }

    // ------- Orijinal speak (kalsın, diğer yerlerde ister kullan) -------
    function speak(text) {
      if (!text) return;
      if (utterance) {
        synth.cancel();
      }
      utterance = new SpeechSynthesisUtterance(text);
      if (selectedVoice) utterance.voice = selectedVoice;
      utterance.lang = 'tr-TR';
      utterance.rate = 0.9;
      utterance.pitch = 1.0;
      utterance.onend = () => {
        statusEl.textContent = 'Okuma tamamlandı.';
        pauseBtn.disabled = true;
        stopBtn.disabled = true;
        playBtn.disabled = false;
        isPaused = false;
        pauseBtn.textContent = '⏸️ Duraklat';
        if (currentIndex < articles.length - 1) {
          currentIndex++;
          playArticle(currentIndex);
        }
      };
      utterance.onerror = (e) => {
        console.error('SpeechSynthesis hata:', e);
        statusEl.textContent = 'Sesli okuma sırasında hata meydana geldi.';
      };
      synth.speak(utterance);
      statusEl.textContent = 'Okuma devam ediyor...';
      pauseBtn.disabled = false;
      stopBtn.disabled = false;
      playBtn.disabled = true;
    }

    function playArticle(idx) {
      if (idx < 0 || idx >= articles.length) return;
      currentIndex = idx;
      updateSelection();
      // A sütunu başlığını çok dilli okuma ile okut
      speakWithLangTags(articles[idx].title);
    }

    function pauseReading() {
      if (synth.speaking && !isPaused) {
        synth.pause();
        isPaused = true;
        statusEl.textContent = 'Okuma duraklatıldı.';
        pauseBtn.textContent = '▶️ Devam Et';
      } else if (synth.paused && isPaused) {
        synth.resume();
        isPaused = false;
        statusEl.textContent = 'Okuma devam ediyor...';
        pauseBtn.textContent = '⏸️ Duraklat';
      }
    }

    function stopReading() {
      if (synth.speaking) {
        synth.cancel();
        isPaused = false;
        statusEl.textContent = 'Okuma durduruldu.';
        pauseBtn.disabled = true;
        stopBtn.disabled = true;
        playBtn.disabled = false;
        pauseBtn.textContent = '⏸️ Duraklat';
      }
    }

    function playPrev() {
      if (currentIndex > 0) {
        playArticle(currentIndex - 1);
      }
    }

    function playNext() {
      if (currentIndex < articles.length - 1) {
        playArticle(currentIndex + 1);
      }
    }

    playBtn.addEventListener('click', () => {
      if (currentIndex === -1 && articles.length > 0) {
        playArticle(0);
      } else if (!synth.speaking) {
        playArticle(currentIndex);
      }
    });
    pauseBtn.addEventListener('click', pauseReading);
    stopBtn.addEventListener('click', stopReading);
    prevBtn.addEventListener('click', playPrev);
    nextBtn.addEventListener('click', playNext);

    fetchArticles();
  </script>
</body>

</html>
