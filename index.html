<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PubMed Makaleleri Podcast OynatÄ±cÄ±sÄ±</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .player-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        button {
            background-color: #336699;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #264d73;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .title-display {
            background-color: #eef7ff;
            border: 1px solid #c7e1ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            min-height: 50px;
            display: flex;
            align-items: center;
            font-size: 16px;
        }
        .progress {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
        }
        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }
        input[type="range"] {
            width: 80px;
        }
        .status {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
            font-style: italic;
        }
        .pubmed-link {
            margin: 5px 0 15px 0;
            font-size: 14px;
        }
        .pubmed-link a {
            color: #336699;
            text-decoration: none;
        }
        .pubmed-link a:hover {
            text-decoration: underline;
        }
        #loadingMessage {
            color: #666;
            font-style: italic;
        }
        
        @media (max-width: 600px) {
            .controls {
                flex-direction: column;
                align-items: flex-start;
            }
            .volume-control {
                margin-left: 0;
                margin-top: 10px;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="player-container">
        <h2>PubMed Makaleleri Podcast</h2>
        <div class="title-display" id="currentTitle">
            Makale baÅŸlÄ±klarÄ±nÄ± TÃ¼rkÃ§e dinlemek iÃ§in oynat dÃ¼ÄŸmesine tÄ±klayÄ±n
        </div>
        <div class="pubmed-link" id="pubmedLink"></div>
        <div id="loadingMessage">Veriler yÃ¼kleniyor...</div>
        <div class="controls">
            <button id="playButton" disabled>â–¶ï¸ Oynat</button>
            <button id="pauseButton" disabled>â¸ï¸ Duraklat</button>
            <button id="stopButton" disabled>â¹ï¸ Durdur</button>
            <button id="prevButton" disabled>â®ï¸ Ã–nceki</button>
            <button id="nextButton" disabled>â­ï¸ Sonraki</button>
            <div class="volume-control">
                <label for="volumeControl">Ses Seviyesi:</label>
                <input type="range" id="volumeControl" min="0" max="1" step="0.1" value="1">
            </div>
        </div>
        <div class="progress">
            <span id="currentIndex">0</span>/<span id="totalTitles">0</span> makale
        </div>
        <div class="status" id="status"></div>
    </div>
    
    <script>
        // DOM elements
        const playButton = document.getElementById('playButton');
        const pauseButton = document.getElementById('pauseButton');
        const stopButton = document.getElementById('stopButton');
        const prevButton = document.getElementById('prevButton');
        const nextButton = document.getElementById('nextButton');
        const currentTitle = document.getElementById('currentTitle');
        const currentIndex = document.getElementById('currentIndex');
        const totalTitles = document.getElementById('totalTitles');
        const volumeControl = document.getElementById('volumeControl');
        const status = document.getElementById('status');
        const loadingMessage = document.getElementById('loadingMessage');
        const pubmedLink = document.getElementById('pubmedLink');

        // Makale baÅŸlÄ±klarÄ± ve PMID deÄŸerleri
        let articleTitles = [];
        let articlePMIDs = [];

        // Google Sheets URL - Shared publicly (view only)
        // Google Sheets bilgileri
        const SHEET_ID = '148p3M41R52gVVjtLSF2Qh8rJvBPEWJ7SV4lgSBQYwLc';
        const SHEET_NAME = 'translate'; // translate sayfasÄ±nÄ± kullanÄ±yoruz
        const SHEET_RANGE = 'A1:A132,F1:F132'; // A sÃ¼tunu baÅŸlÄ±k, F sÃ¼tunu PMID

        async function fetchSheetData() {
            try {
                loadingMessage.textContent = "Google Sheets'ten veriler yÃ¼kleniyor...";
                
                // JSONP formatÄ±nda verileri al
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}&range=${SHEET_RANGE}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('Google Sheets verisi alÄ±namadÄ±');
                }
                
                const responseText = await response.text();
                
                // JSONP yanÄ±tÄ±nÄ± JSON'a dÃ¶nÃ¼ÅŸtÃ¼rme
                const jsonText = responseText.substring(
                    responseText.indexOf('(') + 1, 
                    responseText.lastIndexOf(')')
                );
                
                try {
                    const data = JSON.parse(jsonText);
                    
                    if (data.table && data.table.rows) {
                        console.log("Bulunan satÄ±r sayÄ±sÄ±:", data.table.rows.length);
                        
                        // Debug
                console.log(data.table);
                
                // GeÃ§ici diziler
                const titles = [];
                const pmids = [];
                
                // Her satÄ±r iÃ§in A sÃ¼tununu (baÅŸlÄ±k) ve F sÃ¼tununu (PMID) al
                        data.table.rows.forEach(row => {
                            if (row.c && row.c[0] && row.c[0].v) {
                                const title = row.c[0].v.trim();
                                let pmid = "";
                                
                                // PMID deÄŸeri (F sÃ¼tunu) varsa al
                                if (row.c[1] && row.c[1].v) {
                                    pmid = row.c[1].v.toString().trim();
                                }
                                
                                // Dergi baÅŸlÄ±klarÄ±nÄ± filtrele
                                const isDergiAdi = title.includes('ğŸ“˜') || 
                                                  title.includes('[resmi sayfa]') || 
                                                  title.length < 10 ||
                                                  /Journal|Pathology|Archiv|APMIS|Histopathology/i.test(title);
                                
                                // Sadece makale baÅŸlÄ±klarÄ±nÄ± al
                                if (!isDergiAdi) {
                                    titles.push(title);
                                    pmids.push(pmid);
                                }
                            }
                        });
                        
                        console.log("Ä°ÅŸlenen baÅŸlÄ±k sayÄ±sÄ±:", titles.length);
                        
                        if (titles.length > 0) {
                            // Makale baÅŸlÄ±k ve PMID'lerini kaydet
                            articleTitles = titles;
                            articlePMIDs = pmids;
                            
                            // UI'Ä± gÃ¼ncelle
                            totalTitles.textContent = articleTitles.length;
                            loadingMessage.style.display = 'none';
                            enablePlayerControls();
                        } else {
                            throw new Error('Ä°ÅŸlenebilir baÅŸlÄ±k bulunamadÄ±');
                        }
                    } else {
                        throw new Error('Tablo verileri alÄ±namadÄ±');
                    }
                } catch (jsonError) {
                    console.error('JSON ayrÄ±ÅŸtÄ±rma hatasÄ±:', jsonError);
                    console.log('AlÄ±nan JSON yanÄ±tÄ±:', jsonText);
                    throw new Error('Veri formatÄ± okunamadÄ±');
                }
            } catch (error) {
                console.error('Veri alma hatasÄ±:', error);
                loadingMessage.textContent = 'Google Sheets verileri yÃ¼klenemedi - Demo baÅŸlÄ±klar kullanÄ±lÄ±yor';
                
                // VarsayÄ±lan baÅŸlÄ±klara geÃ§
                useDemoTitles();
            }
        }
        
        // SpeechSynthesis instance
        const synth = window.speechSynthesis;
        let utterance = null;
        let currentTitleIndex = 0;
        let isPaused = false;
        let voices = [];
        let selectedVoice = null;
        
        function extractTitleFromCell(content) {
            if (!content) return null;
            
            let title = content;
            
            // HTML iÃ§eriÄŸi temizleme
            if (typeof content === 'string' && (content.includes('<') || content.includes('&'))) {
                try {
                    // HTML varlÄ±ÄŸÄ±nÄ± kontrol et ve temizle
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = content;
                    title = tempDiv.textContent.trim();
                } catch (e) {
                    console.warn('HTML ayrÄ±ÅŸtÄ±rma hatasÄ±:', e);
                }
            }
            
            // Ä°lk olarak makale baÅŸlÄ±klarÄ±nÄ± bulalÄ±m (tire ile baÅŸlayan)
            if (title.startsWith('-')) {
                title = title.substring(1).trim();
                
                // Yazar ve dergi bilgilerini kaldÄ±r
                const parenIndex = title.indexOf('(');
                if (parenIndex > 0) {
                    title = title.substring(0, parenIndex).trim();
                }
                
                // Link kelimesini ve noktalama iÅŸaretlerini temizle
                title = title.replace(/\s*Link\s*$/i, '')
                             .replace(/\s*\.$/, '.')  // Nokta varsa koru ama boÅŸluklarÄ± kaldÄ±r
                             .trim();
                
                return title.length > 0 ? title : null;
            }
            
            // Tire ile baÅŸlamayan iÃ§erikte makale baÅŸlÄ±ÄŸÄ± aramayÄ± dene
            if (title.includes('.') && !title.startsWith('ğŸ“˜') && !title.includes('[resmi sayfa]')) {
                // Nokta ile bitiyor mu?
                const parts = title.split('.');
                if (parts.length > 1) {
                    // Ä°lk anlamlÄ± parÃ§ayÄ± al
                    for (let part of parts) {
                        part = part.trim();
                        if (part.length > 15) { // Makul bir baÅŸlÄ±k uzunluÄŸu
                            return part;
                        }
                    }
                }
            }
            
            return null;
        }

        // HTML iÅŸleme fonksiyonunu kaldÄ±rÄ±yorum - artÄ±k kullanmÄ±yoruz
        function processArticleTitles(content) {
            // Bu fonksiyon artÄ±k kullanÄ±lmÄ±yor
            console.log("processArticleTitles fonksiyonu kaldÄ±rÄ±ldÄ±, yeni yaklaÅŸÄ±m kullanÄ±lÄ±yor");
        }
        
        // Demo baÅŸlÄ±k ve PMID'ler - hata durumunda gÃ¶sterilecek
        function useDemoTitles() {
            articleTitles = [
                "Yapay Zeka destekli gÃ¶rÃ¼ntÃ¼ analizi, kÃ¼Ã§Ã¼k hÃ¼creli olmayan akciÄŸer kanserinde standartlaÅŸtÄ±rÄ±lmÄ±ÅŸ programlanmÄ±ÅŸ Ã¶lÃ¼m-ligand 1 ekspresyonu deÄŸerlendirmesi iÃ§in.",
                "Bifazik (skuamoid) papiller bÃ¶brek hÃ¼creli karsinom: PRCC spektrumu iÃ§inde belirgin bir molekÃ¼ler ve morfolojik alt tip.",
                "RPL22 Ekspresyonunun KaybÄ±, TÃ¼mÃ¶rle Ä°liÅŸkili Lenfosit SayÄ±larÄ±nÄ±n Daha DÃ¼ÅŸÃ¼k OlduÄŸu MLH1 Eksik Endometriyal Kanserlerin Transkripsiyonel Bir Alt KÃ¼mesini Belirler.",
                "Histopatolojik Ä°Ã§gÃ¶rÃ¼ler Curvularia-Ä°ndÃ¼klenen Kronik GranÃ¼lomatÃ¶z Fungal SinÃ¼zit: Cerrahi Patologlar Ä°Ã§in Bir Rehber.",
                "ALK-Yeniden DÃ¼zenlenmiÅŸ Mezenkimal Neoplazm Hiyalin-VaskÃ¼ler Castleman HastalÄ±ÄŸÄ± Benzeri Ã–zelliklerle: Bir Olgu Sunumu."
            ];
            
            articlePMIDs = [
                "41013460",
                "41006900",
                "41005533",
                "41005534",
                "41001954"
            ];
            
            totalTitles.textContent = articleTitles.length;
            loadingMessage.style.display = 'none';
            enablePlayerControls();
        }
        
        // Enable player controls once data is loaded
        function enablePlayerControls() {
            playButton.disabled = false;
            prevButton.disabled = true; // Initially disabled
            nextButton.disabled = articleTitles.length <= 1;
            status.textContent = "HazÄ±r";
        }

        // Initialize the UI and load data
        function init() {
            // Try to fetch data from Google Sheets
            fetchSheetData();
            
            // Load available voices
            loadVoices();
            if (synth.onvoiceschanged !== undefined) {
                synth.onvoiceschanged = loadVoices;
            }

            // Set up event listeners
            playButton.addEventListener('click', play);
            pauseButton.addEventListener('click', pause);
            stopButton.addEventListener('click', stop);
            prevButton.addEventListener('click', previous);
            nextButton.addEventListener('click', next);
            volumeControl.addEventListener('input', updateVolume);
        }

        // Load available voices and select Turkish
        function loadVoices() {
            voices = synth.getVoices();
            
            // Try to find a Turkish voice
            selectedVoice = voices.find(voice => 
                voice.lang === 'tr-TR' || 
                voice.lang === 'tr' || 
                voice.name.toLowerCase().includes('turkish') ||
                voice.name.toLowerCase().includes('tÃ¼rk')
            );
            
            // If no Turkish voice is found, try to find any voice that might work
            if (!selectedVoice) {
                console.warn('TÃ¼rkÃ§e ses bulunamadÄ±, varsayÄ±lan ses kullanÄ±lÄ±yor.');
                // Just use the first available voice or a default one
                selectedVoice = voices.find(voice => voice.default) || voices[0];
            }
            
            if (selectedVoice) {
                console.log('SeÃ§ilen ses:', selectedVoice.name, selectedVoice.lang);
            }
            
            // If we have data and voices, enable the player
            if (articleTitles.length > 0 && voices.length > 0) {
                enablePlayerControls();
            }
        }

        // Create a new speech utterance
        function createUtterance(text) {
            utterance = new SpeechSynthesisUtterance(text);
            
            // Set the selected Turkish voice if available
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }
            
            // Set optimal parameters for Turkish pronunciation
            utterance.lang = 'tr-TR'; // Try to force Turkish language
            utterance.pitch = 1.0;    // Normal pitch
            utterance.rate = 0.9;     // Slightly slower for clarity
            utterance.volume = parseFloat(volumeControl.value);
            
            // Handle when speech ends
            utterance.onend = () => {
                if (!isPaused) {
                    // Move to the next title
                    if (currentTitleIndex < articleTitles.length - 1) {
                        currentTitleIndex++;
                        speakCurrentTitle();
                    } else {
                        // End of playlist
                        resetPlayer();
                        status.textContent = "Makalelerin sonuna ulaÅŸÄ±ldÄ±";
                    }
                }
            };

            utterance.onerror = (event) => {
                console.error('SpeechSynthesis hatasÄ±:', event);
                status.textContent = "KonuÅŸma sÄ±rasÄ±nda bir hata oluÅŸtu";
            };
        }

        // Speak the current title
        function speakCurrentTitle() {
            updateDisplay();
            
            const title = articleTitles[currentTitleIndex];
            createUtterance(title);
            synth.speak(utterance);
            
            status.textContent = "KonuÅŸuyor...";
            updateButtonState(true);
        }

        // Update the display
        function updateDisplay() {
            // BaÅŸlÄ±ÄŸÄ± gÃ¶ster
            currentTitle.textContent = articleTitles[currentTitleIndex];
            
            // PMID varsa PubMed linkini gÃ¶ster
            const pubmedLink = document.getElementById('pubmedLink');
            const pmid = articlePMIDs[currentTitleIndex];
            
            if (pmid && pmid.trim() !== "") {
                pubmedLink.innerHTML = `<a href="https://pubmed.ncbi.nlm.nih.gov/${pmid}" target="_blank">PubMed: ${pmid}</a>`;
            } else {
                pubmedLink.innerHTML = "";
            }
            
            // Ä°ndeksi gÃ¼ncelle
            currentIndex.textContent = currentTitleIndex + 1;
        }

        // Update button states
        function updateButtonState(isPlaying) {
            playButton.disabled = isPlaying;
            pauseButton.disabled = !isPlaying;
            stopButton.disabled = !isPlaying;
            prevButton.disabled = currentTitleIndex === 0 || isPlaying;
            nextButton.disabled = currentTitleIndex >= articleTitles.length - 1 || isPlaying;
        }

        // Reset the player
        function resetPlayer() {
            synth.cancel();
            isPaused = false;
            updateButtonState(false);
            status.textContent = "HazÄ±r";
        }

        // Event handlers
        function play() {
            if (synth.speaking && isPaused) {
                // Resume if paused
                synth.resume();
                isPaused = false;
                status.textContent = "KonuÅŸuyor...";
            } else {
                // Start new speech
                speakCurrentTitle();
            }
            updateButtonState(true);
        }

        function pause() {
            if (synth.speaking) {
                synth.pause();
                isPaused = true;
                status.textContent = "DuraklatÄ±ldÄ±";
            }
        }

        function stop() {
            resetPlayer();
        }

        function previous() {
            if (currentTitleIndex > 0) {
                currentTitleIndex--;
                updateDisplay();
            }
        }

        function next() {
            if (currentTitleIndex < articleTitles.length - 1) {
                currentTitleIndex++;
                updateDisplay();
            }
        }

        function updateVolume() {
            if (utterance) {
                utterance.volume = parseFloat(volumeControl.value);
            }
        }

        // Initialize when the page loads
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
