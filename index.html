<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Günlük Patoloji Makaleleri - Sesli Podcast</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica Neue, Arial, sans-serif; background: linear-gradient(135deg, #f5f7fa 0, #c3cfe2 100); color: #2c3e50; min-height: 100vh; padding: 20px; }
.container { max-width: 1400px; margin: 0 auto; }
header { text-align: center; margin-bottom: 30px; padding: 25px 20px; background: #fff; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
h1 { font-size: 2.5em; font-weight: 800; color: #2c3e50; margin-bottom: 8px; }
.subtitle { font-size: 1em; color: #7f8c8d; font-weight: 400; }
.date-badge { display: inline-block; margin-top: 10px; padding: 6px 16px; background: linear-gradient(135deg, #3498db 0, #2980b9 100); color: white; border-radius: 20px; font-size: 0.9em; font-weight: 600; }
.player-container { position: sticky; top: 20px; background: white; border-radius: 16px; padding: 24px 32px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 30px; z-index:100; border: 1px solid #e1e8ed; display: flex; flex-direction: row; align-items: center; justify-content: flex-start; gap: 20px; flex-wrap: wrap; }
.player-controls { display: flex; gap: 12px; align-items: center; }
#playBtn {
  background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
  color: white;
  border: none;
  border-radius: 10px;
  padding: 12px 32px;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  min-width: 105px;
  box-shadow: 0 3px 10px rgba(52,152,219,0.22);
  transition: all 0.22s cubic-bezier(.4,1.3,.6,1);
  outline: none;
}
#playBtn:hover:not(:disabled) {
  background: linear-gradient(135deg, #62a9fa 0%, #0072ff 100%);
  transform: translateY(-2px) scale(1.04);
  box-shadow: 0 7px 20px rgba(52,152,219,0.38);
}
#stopBtn {
  background: linear-gradient(135deg, #fb7185 0%, #fca5a5 100%);
  color: white;
  border: none;
  border-radius: 10px;
  padding: 12px 32px;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  min-width: 105px;
  box-shadow: 0 3px 10px rgba(251,113,133,0.18);
  transition: all 0.22s cubic-bezier(.4,1.3,.6,1);
  outline: none;
}
#stopBtn:hover:not(:disabled) {
  background: linear-gradient(125deg, #fd3152 0%, #fd8ba8 100%);
  transform: translateY(-2px) scale(1.04);
  box-shadow: 0 7px 20px rgba(251,113,133,0.26);
}
.player-controls button:disabled {
  background: #bdc3c7;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
  opacity: 0.55;
}
.articles-section { margin-top: 30px; }
.journal-group { margin-bottom: 40px; }
.journal-title { font-size: 1.5em; color: #2c3e50; margin-bottom: 20px; padding: 15px 20px; background: white; border-radius: 12px; font-weight: 700; display: flex; align-items: center; gap: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid #3498db; }
.articles-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
.article-card { background: white; border-radius: 16px; padding: 24px; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.06); transition: all 0.3s ease; border: 2px solid transparent; position: relative; }
.article-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.12); border-color: #3498db; }
.article-card.active { border-color: #e74c3c; box-shadow: 0 8px 25px rgba(231,76,60,0.2); background: #fff5f5; }
.article-title { font-size: 16px; font-weight: 600; line-height: 1.5; color: #2c3e50; margin-bottom: 12px; }
.article-meta { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 12px; font-size: 0.85em; color: #7f8c8d; }
.meta-item { display: flex; align-items: center; gap: 4px; background: #f8f9fa; padding: 4px 10px; border-radius: 8px; }
.article-badges { display: flex; gap: 8px; flex-wrap: wrap; }
.link-badge { background: #e8f8f5; color: #16a085; padding: 6px 12px; border-radius: 8px; font-size: 0.85em; font-weight: 600; border: 1px solid #c8e6e0; text-decoration: none; transition: all 0.2s ease; }
footer { margin-top: 50px; padding: 30px; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); text-align: center; color: #7f8c8d; font-size: 0.95em; line-height: 1.8; }
footer h3 { color: #2c3e50; font-size: 1.2em; margin-bottom: 15px; font-weight: 700; }
footer p { margin-bottom: 10px; }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Günlük Patoloji Makaleleri</h1>
    <div class="subtitle">Her Güne Özel Sesli Podcast</div>
    <div class="date-badge" id="currentDate"></div>
  </header>
  <div class="player-container">
    <div class="player-controls">
      <button id="playBtn" disabled>Oynat</button>
      <button id="stopBtn" disabled>Durdur</button>
    </div>
    <div id="status"></div>
  </div>
  <div class="articles-section" id="articlesSection"></div>
  <footer>
    <h3>Kaynak Bilgisi</h3>
    <p><strong>Dergiler:</strong> <span id="journalNames">Yükleniyor...</span></p>
    <p>Makaleler PubMed API aracılığıyla günlük olarak otomatik ekilmektedir.</p>
    <p>Bu içerik eğitim ve bilgilendirme amaçlıdır. Telif hakkı koruması altında değildir.</p>
    <p class="journal-list">Tüm makaleler PubMed veritabanından her gün otomatik olarak alınmaktadır.</p>
  </footer>
</div>
<script>
const SHEETID = "148p3M41R52gVVjtLSF2Qh8rJvBPEWJ7SV4lgSBQYwLc";
const GID = "1109640564";
let articles = [];
let journalGroups = [];
let currentIndex = -1;
let synth = window.speechSynthesis;
let utterance = null;
let voices;
let selectedVoiceTR = null;
const JOURNALROWS = [0, 11, 22, 33, 44, 55, 66, 77, 88, 99, 110, 121];
const articlesSectionEl = document.getElementById("articlesSection");
const statusEl = document.getElementById("status");
const playBtn = document.getElementById("playBtn");
const stopBtn = document.getElementById("stopBtn");
let customWords = {};

async function loadCustomWords() {
  if (Object.keys(customWords).length > 0) return;
  try {
    const res = await fetch("customWords.json");
    if (!res.ok) throw new Error("customWords.json yüklenemedi");
    customWords = await res.json();
  } catch (e) {
    customWords = {};
    console.warn("Özel okunuşlar yüklenemedi, devam ediliyor.", e);
  }
}
function replaceWithCustomPronunciation(text) {
  for (const [word, pronunciation] of Object.entries(customWords)) {
    const regex = new RegExp(`\\b${word}\\b`, 'gi');
    text = text.replace(regex, pronunciation);
  }
  return text;
}
function setCurrentDate() {
  const options = { day: 'numeric', month: 'long', year: 'numeric' };
  const today = new Date().toLocaleDateString('tr-TR', options);
  document.getElementById("currentDate").textContent = today;
}
function loadVoices() {
  voices = synth.getVoices();
  selectedVoiceTR = voices.find(v =>
    (v.lang === "tr-TR" || v.lang.startsWith("tr")) &&
    (v.name.toLowerCase().includes("turkish") || v.name.toLowerCase().includes("trk"))
  );
  if (!selectedVoiceTR && voices.length > 0) selectedVoiceTR = voices[0];
}
if (speechSynthesis.onvoiceschanged !== undefined) {
  speechSynthesis.onvoiceschanged = loadVoices;
}
loadVoices();
async function fetchArticles() {
  const url = `https://docs.google.com/spreadsheets/d/${SHEETID}/gviz/tq?tqx=out:json&gid=${GID}&range=A1:F132&headers=0`;
  try {
    statusEl.innerHTML = "Makale listesi yükleniyor...";
    const res = await fetch(url);
    if (!res.ok) throw new Error("Veri alınamadı");
    const text = await res.text();
    const jsonText = text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1);
    const data = JSON.parse(jsonText);
    if (!data.table || !data.table.rows) throw new Error("Tablo verisi alınamadı");
    let currentJournal = "";
    let tempJournalGroups = [], tempArticles = [];
    data.table.rows.forEach((row, idx) => {
      let titleA = row.c[0]?.v?.toString().trim();
      let author = row.c[1]?.v?.toString().trim();
      let date = row.c[3]?.v?.toString().trim();
      let detailE = row.c[4]?.v?.toString().trim();
      let pmid = row.c[5]?.v?.toString().trim();
      let pubmedLink = (detailE && detailE.match(/href=['\"]([^'\"]+)['\"]/)) ? RegExp.$1 : (pmid ? `https://pubmed.ncbi.nlm.nih.gov/${pmid}` : "");
      if (JOURNALROWS.includes(idx)) {
        if (currentJournal && tempArticles.length) tempJournalGroups.push({journal: currentJournal, articles: [...tempArticles]});
        currentJournal = titleA;
        tempArticles = [];
      } else if (titleA && titleA.length > 10 && !JOURNALROWS.includes(idx)) {
        tempArticles.push({ title: titleA, author, date, detail: detailE, link: pubmedLink, pmid, journal: currentJournal });
      }
    });
    if (currentJournal && tempArticles.length) tempJournalGroups.push({journal: currentJournal, articles: [...tempArticles]});
    articles = [];
    tempJournalGroups.forEach(group => articles.push(...group.articles));
    journalGroups = tempJournalGroups;
    renderArticleList();
    updateJournalNames();
    enableControls();
    statusEl.innerHTML = "";
  } catch (e) {
    console.error(e);
    statusEl.innerHTML = "Makale listesi yüklenemedi.";
  }
}
function updateJournalNames() {
  const journalNames = journalGroups.map(g => g.journal).join(", ");
  document.getElementById("journalNames").textContent = journalNames;
}
function renderArticleList() {
  articlesSectionEl.innerHTML = "";
  let globalIndex = 0;
  journalGroups.forEach(group => {
    const groupDiv = document.createElement("div");
    groupDiv.className = "journal-group";
    const titleDiv = document.createElement("div");
    titleDiv.className = "journal-title";
    titleDiv.textContent = group.journal;
    groupDiv.appendChild(titleDiv);
    const gridDiv = document.createElement("div");
    gridDiv.className = "articles-grid";
    group.articles.forEach(article => {
      const articleIdx = globalIndex++;
      const card = document.createElement("div");
      card.className = "article-card";
      card.innerHTML =
        `<div class="article-title">${article.title}</div>
         <div class="article-meta">${article.author ? `<div class="meta-item">${article.author}</div>` : ""}
         ${article.date ? `<div class="meta-item">${article.date}</div>` : ""}
         ${article.journal ? `<div class="meta-item">${article.journal}</div>` : ""}
         ${article.pmid ? `<div class="meta-item">PMID ${article.pmid}</div>` : ""}</div>
         <div class="article-badges">${article.link ? `<a href="${article.link}" target="_blank" class="link-badge" onclick="event.stopPropagation()">PubMed</a>` : ""}</div>`;
      card.addEventListener("click", () => playArticle(articleIdx));
      gridDiv.appendChild(card);
    });
    groupDiv.appendChild(gridDiv);
    articlesSectionEl.appendChild(groupDiv);
  });
}
function enableControls() {
  playBtn.disabled = false;
  stopBtn.disabled = true;
}
function updateSelection() {
  const allCards = document.querySelectorAll(".article-card");
  allCards.forEach((card, idx) => card.classList.toggle("active", idx === currentIndex));
  if (currentIndex >= 0 && currentIndex < articles.length) {
    const activeCard = allCards[currentIndex];
    if (activeCard) activeCard.scrollIntoView({ behavior: "smooth", block: "center" });
  }
}
async function speak(text) {
  if (!text) return;
  await loadCustomWords();
  if (utterance) synth.cancel();
  let ttsText = replaceWithCustomPronunciation(text);
  utterance = new SpeechSynthesisUtterance(ttsText);
  if (selectedVoiceTR) {
    utterance.voice = selectedVoiceTR;
    utterance.lang = "tr-TR";
  }
  utterance.rate = 0.9;
  utterance.pitch = 1.0;
  utterance.onend = () => {
    statusEl.innerHTML = "";
    stopBtn.disabled = true;
    playBtn.disabled = false;
    if (currentIndex < articles.length - 1) setTimeout(() => playArticle(currentIndex + 1), 1000);
  };
  utterance.onerror = e => {
    console.error("SpeechSynthesis hata:", e);
    statusEl.innerHTML = "Sesli okuma hatası!";
  };
  synth.speak(utterance);
  statusEl.innerHTML = "Okunuyor...";
  stopBtn.disabled = false;
  playBtn.disabled = true;
}
async function playArticle(idx) {
  if (idx < 0 || idx >= articles.length) return;
  currentIndex = idx;
  updateSelection();
  await speak(articles[idx].title);
}
function stopReading() {
  if (synth.speaking) synth.cancel();
  statusEl.innerHTML = "";
  stopBtn.disabled = true;
  playBtn.disabled = false;
}
playBtn.addEventListener("click", () => {
  if (currentIndex === -1 && articles.length) playArticle(0);
  else if (!synth.speaking) playArticle(currentIndex);
});
stopBtn.addEventListener("click", stopReading);

setCurrentDate();
fetchArticles();
</script>
</body>
</html>
